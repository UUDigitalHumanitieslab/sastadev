
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>corrector &#8212; SASTA  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SASTA  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">corrector</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for corrector</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;&#39;</span>
<span class="sd">to be added</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">alpino</span> <span class="k">import</span> <span class="n">getdehetwordinfo</span>
<span class="kn">from</span> <span class="nn">basicreplacements</span> <span class="k">import</span> <span class="p">(</span><span class="n">basicexpansions</span><span class="p">,</span> <span class="n">basicreplacements</span><span class="p">,</span>
                               <span class="n">getdisambiguationdict</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">cleanCHILDEStokens</span> <span class="k">import</span> <span class="n">cleantokens</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="k">import</span> <span class="n">PARSE_FUNC</span><span class="p">,</span> <span class="n">SDLOGGER</span>
<span class="kn">from</span> <span class="nn">dedup</span> <span class="k">import</span> <span class="p">(</span><span class="n">cleanwordofnort</span><span class="p">,</span> <span class="n">find_duplicates2</span><span class="p">,</span> <span class="n">find_janeenouduplicates</span><span class="p">,</span>
                   <span class="n">find_simpleduplicates</span><span class="p">,</span> <span class="n">find_substringduplicates2</span><span class="p">,</span>
                   <span class="n">getfilledpauses</span><span class="p">,</span> <span class="n">getprefixwords</span><span class="p">,</span> <span class="n">getrepeatedtokens</span><span class="p">,</span>
                   <span class="n">getunwantedtokens</span><span class="p">,</span> <span class="n">nodesfindjaneenou</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">deregularise</span> <span class="k">import</span> <span class="n">correctinflection</span>
<span class="kn">from</span> <span class="nn">iedims</span> <span class="k">import</span> <span class="n">getjeforms</span>
<span class="kn">from</span> <span class="nn">lexicon</span> <span class="k">import</span> <span class="n">de</span><span class="p">,</span> <span class="n">dets</span><span class="p">,</span> <span class="n">getwordinfo</span><span class="p">,</span> <span class="n">het</span><span class="p">,</span> <span class="n">informlexicon</span><span class="p">,</span> <span class="n">known_word</span><span class="p">,</span> <span class="n">isa_namepart</span><span class="p">,</span> <span class="n">tswnouns</span><span class="p">,</span> <span class="n">WordInfo</span>
<span class="kn">from</span> <span class="nn">macros</span> <span class="k">import</span> <span class="n">expandmacros</span>
<span class="c1"># from namepartlexicon import namepart_isa_namepart</span>
<span class="kn">from</span> <span class="nn">sastatok</span> <span class="k">import</span> <span class="n">sasta_tokenize</span>
<span class="kn">from</span> <span class="nn">sastatoken</span> <span class="k">import</span> <span class="n">Token</span><span class="p">,</span> <span class="n">tokenlist2stringlist</span>
<span class="kn">from</span> <span class="nn">stringfunctions</span> <span class="k">import</span> <span class="p">(</span><span class="n">chatxxxcodes</span><span class="p">,</span> <span class="n">consonants</span><span class="p">,</span> <span class="n">deduplicate</span><span class="p">,</span>
                             <span class="n">endsinschwa</span><span class="p">,</span> <span class="n">fullworddehyphenate</span><span class="p">,</span> <span class="n">monosyllabic</span><span class="p">,</span>
                             <span class="n">vowels</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">sva</span> <span class="k">import</span> <span class="n">getsvacorrections</span>
<span class="kn">from</span> <span class="nn">tokenmd</span> <span class="k">import</span> <span class="n">TokenListMD</span><span class="p">,</span> <span class="n">TokenMD</span><span class="p">,</span> <span class="n">mdlist2listmd</span>
<span class="kn">from</span> <span class="nn">treebankfunctions</span> <span class="k">import</span> <span class="n">find1</span><span class="p">,</span> <span class="n">getattval</span><span class="p">,</span> <span class="n">getnodeyield</span><span class="p">,</span> <span class="n">showtree</span><span class="p">,</span> <span class="n">treeinflate</span><span class="p">,</span> <span class="n">fatparse</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="k">import</span> <span class="n">etree</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="c1"># from alternative import Alternative, Replacement, Metadata, Meta</span>
<span class="kn">from</span> <span class="nn">metadata</span> <span class="k">import</span> <span class="n">Meta</span><span class="p">,</span> <span class="n">defaultbackplacement</span><span class="p">,</span> <span class="n">defaultpenalty</span><span class="p">,</span> <span class="n">bpl_node</span><span class="p">,</span> <span class="n">bpl_none</span><span class="p">,</span> <span class="n">bpl_word</span><span class="p">,</span> <span class="n">bpl_indeze</span><span class="p">,</span> \
    <span class="n">bpl_wordlemma</span><span class="p">,</span> <span class="n">mkSASTAMeta</span><span class="p">,</span> <span class="n">janeenou</span><span class="p">,</span> <span class="n">shortrep</span><span class="p">,</span> <span class="n">longrep</span><span class="p">,</span> <span class="n">repeatedseqtoken</span><span class="p">,</span> <span class="n">intj</span><span class="p">,</span> <span class="n">unknownword</span><span class="p">,</span> <span class="n">unknownsymbol</span><span class="p">,</span> \
    <span class="n">filled_pause</span><span class="p">,</span> <span class="n">repeatedjaneenou</span><span class="p">,</span> <span class="n">repeated</span><span class="p">,</span> <span class="n">substringrep</span><span class="p">,</span> <span class="n">fstoken</span><span class="p">,</span> <span class="n">falsestart</span>
<span class="kn">from</span> <span class="nn">alpinoparsing</span> <span class="k">import</span> <span class="n">parse</span><span class="p">,</span> <span class="n">escape_alpino_input</span>
<span class="kn">from</span> <span class="nn">expandquery</span> <span class="k">import</span> <span class="n">expandmacros</span>
<span class="kn">from</span> <span class="nn">find_ngram</span> <span class="k">import</span> <span class="n">Ngram</span><span class="p">,</span> <span class="n">findmatches</span><span class="p">,</span> <span class="n">ngram1</span><span class="p">,</span> <span class="n">ngram2</span><span class="p">,</span> <span class="n">ngram7</span><span class="p">,</span> <span class="n">ngram10</span><span class="p">,</span> <span class="n">ngram11</span><span class="p">,</span> <span class="n">ngram16</span><span class="p">,</span> <span class="n">ngram17</span>
<span class="kn">from</span> <span class="nn">smallclauses</span> <span class="k">import</span> <span class="n">smallclauses</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">sastatypes</span> <span class="k">import</span> <span class="n">BackPlacement</span><span class="p">,</span> <span class="n">MethodName</span><span class="p">,</span> <span class="n">Nort</span><span class="p">,</span> <span class="n">Penalty</span><span class="p">,</span> <span class="n">Position</span><span class="p">,</span> <span class="n">SynTree</span><span class="p">,</span> <span class="n">UttId</span>

<span class="n">Correction</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Meta</span><span class="p">]]</span>
<span class="n">MetaCondition</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Meta</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]</span>

<span class="n">SASTA</span> <span class="o">=</span> <span class="s1">&#39;SASTA&#39;</span>

<span class="n">hyphen</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
<span class="n">repetition</span> <span class="o">=</span> <span class="s1">&#39;Repetition&#39;</span>

<span class="n">replacepattern</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> [: </span><span class="si">{}</span><span class="s1"> ]&#39;</span>
<span class="n">metatemplate</span> <span class="o">=</span> <span class="s1">&#39;##META </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">&#39;</span>
<span class="n">slash</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
<span class="n">space</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

<span class="n">disambiguationdict</span> <span class="o">=</span> <span class="n">getdisambiguationdict</span><span class="p">()</span>

<span class="n">wrongdet_excluded_words</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;zijn&#39;</span><span class="p">,</span> <span class="s1">&#39;dicht&#39;</span><span class="p">,</span> <span class="s1">&#39;met&#39;</span><span class="p">,</span> <span class="s1">&#39;ik&#39;</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Ngramcorrection</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ngram</span><span class="p">,</span> <span class="n">fpositions</span><span class="p">,</span> <span class="n">cpositions</span><span class="p">,</span> <span class="n">metafunction</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngram</span><span class="p">:</span> <span class="n">Ngram</span> <span class="o">=</span> <span class="n">ngram</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fpositions</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Position</span><span class="p">,</span> <span class="n">Position</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpositions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpositions</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Position</span><span class="p">,</span> <span class="n">Position</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpositions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metafunction</span> <span class="o">=</span> <span class="n">metafunction</span>


<span class="k">def</span> <span class="nf">mkmeta</span><span class="p">(</span><span class="n">att</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">metatemplate</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">att</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">anychars</span><span class="p">(</span><span class="n">chars</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">chars</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">opt</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s1">&#39;)?&#39;</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">replacement</span><span class="p">(</span><span class="n">inword</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">outword</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">replacepattern</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inword</span><span class="p">,</span> <span class="n">outword</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="c1"># duppattern = r&#39;(.)\1{2,}&#39;</span>
<span class="c1"># dupre = re.compile(duppattern)</span>
<span class="n">gaatiepattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^.*&#39;</span> <span class="o">+</span> <span class="n">anychars</span><span class="p">(</span><span class="n">vowels</span><span class="p">)</span> <span class="o">+</span> <span class="n">opt</span><span class="p">(</span><span class="n">anychars</span><span class="p">(</span><span class="n">consonants</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;tie$&#39;</span>
<span class="n">gaatiere</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">gaatiepattern</span><span class="p">)</span>
<span class="n">neutersgnoun</span> <span class="o">=</span> <span class="s1">&#39;boekje&#39;</span>  <span class="c1"># seecet here an unambiguous neuter noun</span>


<span class="k">def</span> <span class="nf">skiptokens</span><span class="p">(</span><span class="n">tokenlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">skiptokenlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">]:</span>
    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    :param tokenlist:</span>
<span class="sd">    :param skiptokenlist:</span>
<span class="sd">    :return: a tokenlist identical to the input tokenlist but with the tokens that also occur with the same pos</span>
<span class="sd">    in skiptokenlist marked with skip=True</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">skippositions</span> <span class="o">=</span> <span class="p">{</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">skiptokenlist</span><span class="p">}</span>
    <span class="n">resultlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokenlist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="ow">in</span> <span class="n">skippositions</span><span class="p">:</span>
            <span class="n">newtoken</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newtoken</span> <span class="o">=</span> <span class="n">token</span>
        <span class="n">resultlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newtoken</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resultlist</span>


<span class="k">def</span> <span class="nf">ngramreduction</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">token2nodemap</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Token</span><span class="p">,</span> <span class="n">SynTree</span><span class="p">]</span> <span class="p">,</span> <span class="n">allremovetokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span>
                   <span class="n">allremovepositions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Position</span><span class="p">],</span> <span class="n">allmetadata</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Meta</span><span class="p">],</span> <span class="n">ngramcor</span><span class="p">:</span> <span class="n">Ngramcorrection</span><span class="p">)</span> \
          <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Meta</span><span class="p">]]:</span>
    <span class="c1"># metadat function should still be added / abstracted</span>
    <span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">fe</span><span class="p">)</span> <span class="o">=</span> <span class="n">ngramcor</span><span class="o">.</span><span class="n">fpositions</span>
    <span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">ce</span><span class="p">)</span> <span class="o">=</span> <span class="n">ngramcor</span><span class="o">.</span><span class="n">cpositions</span>
    <span class="n">reducedleaves</span> <span class="o">=</span> <span class="p">[</span><span class="n">token2nodemap</span><span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span><span class="p">]</span>

    <span class="n">vnwpvvnwpvmatches</span> <span class="o">=</span> <span class="n">findmatches</span><span class="p">(</span><span class="n">ngramcor</span><span class="o">.</span><span class="n">ngram</span><span class="p">,</span> <span class="n">reducedleaves</span><span class="p">)</span>
    <span class="n">allfalsestarttokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">vnwpvvnwpvmatches</span><span class="p">:</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">falsestartpositions</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tok</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">[</span><span class="n">fb</span><span class="p">:</span><span class="n">fe</span><span class="p">]]</span>
        <span class="n">falsestarttokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">pos</span> <span class="ow">in</span> <span class="n">falsestartpositions</span><span class="p">]</span>
        <span class="n">allfalsestarttokens</span> <span class="o">+=</span> <span class="n">falsestarttokens</span>
        <span class="n">correcttokenpositions</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tok</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">[</span><span class="n">cb</span><span class="p">:</span><span class="n">ce</span><span class="p">]]</span>
        <span class="n">correcttokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">pos</span> <span class="ow">in</span> <span class="n">correcttokenpositions</span><span class="p">]</span>
        <span class="n">allremovetokens</span> <span class="o">+=</span> <span class="n">falsestarttokens</span>
        <span class="n">allremovepositions</span> <span class="o">+=</span> <span class="n">falsestartpositions</span>
        <span class="n">metadata</span> <span class="o">+=</span> <span class="n">ngramcor</span><span class="o">.</span><span class="n">metafunction</span><span class="p">(</span><span class="n">falsestarttokens</span><span class="p">,</span> <span class="n">falsestartpositions</span><span class="p">,</span> <span class="n">correcttokens</span><span class="p">)</span>
    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allfalsestarttokens</span><span class="p">]</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>
    <span class="k">return</span> <span class="n">reducedtokens</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span> <span class="n">allmetadata</span>


<span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">tree</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SynTree</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Meta</span><span class="p">]]:</span>
    <span class="k">if</span> <span class="n">tree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">SDLOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No tree for :</span><span class="si">{}</span><span class="se">\n</span><span class="s1">No reduction applied&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">tokens</span><span class="p">,</span> <span class="p">[]))</span>

    <span class="n">tokennodes</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s1">&#39;.//node[@pt or @pos]&#39;</span><span class="p">)</span>
    <span class="n">tokennodesdict</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">getattval</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;begin&#39;</span><span class="p">)):</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tokennodes</span><span class="p">}</span>
    <span class="n">token2nodemap</span> <span class="o">=</span> <span class="p">{</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">:</span> <span class="n">tokennodesdict</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span> <span class="k">if</span> <span class="n">keycheck</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">tokennodesdict</span><span class="p">)}</span>

    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="n">tokens</span>
    <span class="n">allmetadata</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">allremovetokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">allremovepositions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># throw out unwanted symbols - -- # etc</span>
    <span class="n">unwantedtokens</span> <span class="o">=</span> <span class="n">getunwantedtokens</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">)</span>
    <span class="n">unwantedpositions</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">unwantedtokens</span><span class="p">]</span>
    <span class="n">allremovetokens</span> <span class="o">+=</span> <span class="n">unwantedtokens</span>
    <span class="n">allremovepositions</span> <span class="o">+=</span> <span class="n">unwantedpositions</span>
    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unwantedtokens</span><span class="p">]</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="s1">&#39;ExtraGrammatical&#39;</span><span class="p">,</span> <span class="n">unknownsymbol</span><span class="p">,</span> <span class="s1">&#39;Syntax&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">unwantedtokens</span><span class="p">]</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>

    <span class="c1"># remove  filled pauses</span>

    <span class="n">filledpausetokens</span> <span class="o">=</span> <span class="n">getfilledpauses</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">)</span>
    <span class="n">filledpausepositions</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">filledpausetokens</span><span class="p">]</span>
    <span class="n">allremovetokens</span> <span class="o">+=</span> <span class="n">filledpausetokens</span>
    <span class="n">allremovepositions</span> <span class="o">+=</span> <span class="n">filledpausepositions</span>
    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filledpausetokens</span><span class="p">]</span>
    <span class="n">reducednodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">token2nodemap</span><span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">keycheck</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">token2nodemap</span><span class="p">)]</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="s1">&#39;ExtraGrammatical&#39;</span><span class="p">,</span> <span class="n">filled_pause</span><span class="p">,</span> <span class="s1">&#39;Syntax&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">filledpausetokens</span><span class="p">]</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>

    <span class="c1"># remove tsw incl goh och h√© oke but not ja, nee, nou</span>
    <span class="n">tswtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">pos</span> <span class="ow">in</span> <span class="n">token2nodemap</span>
                 <span class="ow">and</span> <span class="n">getattval</span><span class="p">(</span><span class="n">token2nodemap</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">pos</span><span class="p">],</span> <span class="s1">&#39;pt&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;tsw&#39;</span>
                 <span class="ow">and</span> <span class="n">getattval</span><span class="p">(</span><span class="n">token2nodemap</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">pos</span><span class="p">],</span> <span class="s1">&#39;lemma&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;ja&#39;</span><span class="p">,</span> <span class="s1">&#39;nee&#39;</span><span class="p">,</span> <span class="s1">&#39;nou&#39;</span><span class="p">}</span>
                 <span class="ow">and</span> <span class="n">getattval</span><span class="p">(</span><span class="n">token2nodemap</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">pos</span><span class="p">],</span> <span class="s1">&#39;lemma&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tswnouns</span><span class="p">]</span>
    <span class="n">tswpositions</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tswtokens</span><span class="p">]</span>
    <span class="n">allremovetokens</span> <span class="o">+=</span> <span class="n">tswtokens</span>
    <span class="n">allremovepositions</span> <span class="o">==</span> <span class="n">tswpositions</span>
    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tswtokens</span><span class="p">]</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="s1">&#39;ExtraGrammatical&#39;</span><span class="p">,</span> <span class="n">intj</span><span class="p">,</span> <span class="s1">&#39;Syntax&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tswtokens</span><span class="p">]</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>

    <span class="c1"># find duplicatenode repetitions of ja, nee, nou</span>
    <span class="n">janeenouduplicatenodes</span> <span class="o">=</span> <span class="n">find_janeenouduplicates</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">)</span>
    <span class="n">allremovetokens</span> <span class="o">+=</span> <span class="n">janeenouduplicatenodes</span>
    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">janeenouduplicatenodes</span><span class="p">]</span>
    <span class="n">reducednodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">token2nodemap</span><span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">keycheck</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">token2nodemap</span><span class="p">)]</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="s1">&#39;ExtraGrammatical&#39;</span><span class="p">,</span> <span class="n">repeatedjaneenou</span><span class="p">,</span> <span class="s1">&#39;Syntax&#39;</span><span class="p">,</span> <span class="n">subcat</span><span class="o">=</span><span class="n">repetition</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">janeenouduplicatenodes</span><span class="p">]</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>

    <span class="c1"># ASTA sec 6.3 p. 11</span>
    <span class="c1"># remove ja nee nou</span>

    <span class="n">janeenounodes</span> <span class="o">=</span> <span class="n">nodesfindjaneenou</span><span class="p">(</span><span class="n">reducednodes</span><span class="p">)</span>
    <span class="n">janeenoutokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span>
                      <span class="n">keycheck</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">token2nodemap</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token2nodemap</span><span class="p">[</span><span class="n">tok</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span> <span class="ow">in</span> <span class="n">janeenounodes</span><span class="p">]</span>
    <span class="n">janeenoupositions</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">janeenoutokens</span><span class="p">]</span>
    <span class="n">allremovetokens</span> <span class="o">+=</span> <span class="n">janeenoutokens</span>
    <span class="n">allremovepositions</span> <span class="o">+=</span> <span class="n">janeenoupositions</span>
    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">janeenoutokens</span><span class="p">]</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="s1">&#39;ExtraGrammatical&#39;</span><span class="p">,</span> <span class="n">janeenou</span><span class="p">,</span> <span class="s1">&#39;Syntax&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">janeenoutokens</span><span class="p">]</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>

    <span class="c1"># short repetitions</span>
    <span class="k">def</span> <span class="nf">oldcond</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Nort</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Nort</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleanwordofnort</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleanwordofnort</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">5</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">informlexicon</span><span class="p">(</span><span class="n">cleanwordofnort</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">cond</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Nort</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Nort</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleanwordofnort</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleanwordofnort</span><span class="p">(</span>
            <span class="n">y</span><span class="p">))</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">5</span>  <span class="c1"># check on lexicon put off actually two variants should be tried if the word is an existin gword</span>

    <span class="n">shortprefixtokens</span> <span class="o">=</span> <span class="n">getprefixwords</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
    <span class="n">shortprefixpositions</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">shortprefixtokens</span><span class="p">]</span>
    <span class="n">repeatedtokens</span> <span class="o">=</span> <span class="n">getrepeatedtokens</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">shortprefixtokens</span><span class="p">)</span>
    <span class="n">allremovetokens</span> <span class="o">+=</span> <span class="n">shortprefixtokens</span>
    <span class="n">allremovepositions</span> <span class="o">+=</span> <span class="n">shortprefixpositions</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">repeatedtokens</span><span class="p">[</span><span class="n">token</span><span class="p">],</span> <span class="s1">&#39;ExtraGrammatical&#39;</span><span class="p">,</span> <span class="n">shortrep</span><span class="p">,</span> <span class="s1">&#39;Tokenisation&#39;</span><span class="p">,</span> <span class="n">subcat</span><span class="o">=</span><span class="n">repetition</span><span class="p">)</span> <span class="k">for</span>
        <span class="n">token</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">repeatedtokens</span><span class="p">]</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>
    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shortprefixtokens</span><span class="p">]</span>

    <span class="c1"># long repetitions</span>
    <span class="k">def</span> <span class="nf">longcond</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Nort</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Nort</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleanwordofnort</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cleanwordofnort</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="o">.</span><span class="mi">5</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">informlexicon</span><span class="p">(</span><span class="n">cleanwordofnort</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="n">longprefixtokens</span> <span class="o">=</span> <span class="n">getprefixwords</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">longcond</span><span class="p">)</span>
    <span class="n">longprefixpositions</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">longprefixtokens</span><span class="p">]</span>
    <span class="n">repeatedtokens</span> <span class="o">=</span> <span class="n">getrepeatedtokens</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">longprefixtokens</span><span class="p">)</span>
    <span class="n">allremovetokens</span> <span class="o">+=</span> <span class="n">longprefixtokens</span>
    <span class="n">allremovepositions</span> <span class="o">+=</span> <span class="n">longprefixpositions</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">repeatedtokens</span><span class="p">[</span><span class="n">token</span><span class="p">],</span> <span class="s1">&#39;ExtraGrammatical&#39;</span><span class="p">,</span> <span class="n">longrep</span><span class="p">,</span> <span class="s1">&#39;Tokenisation&#39;</span><span class="p">,</span> <span class="n">subcat</span><span class="o">=</span><span class="n">repetition</span><span class="p">)</span> <span class="k">for</span>
        <span class="n">token</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">repeatedtokens</span><span class="p">]</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>
    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">longprefixtokens</span><span class="p">]</span>

    <span class="c1"># find unknown words that are a substring of their successor</span>
    <span class="n">substringtokens</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_substringduplicates2</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">)</span>
    <span class="n">substringpositions</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">substringtokens</span><span class="p">]</span>
    <span class="n">repeatedtokens</span> <span class="o">=</span> <span class="n">getrepeatedtokens</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">substringtokens</span><span class="p">)</span>
    <span class="n">allremovetokens</span> <span class="o">+=</span> <span class="n">substringtokens</span>
    <span class="n">allremovepositions</span> <span class="o">+=</span> <span class="n">substringpositions</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">repeatedtokens</span><span class="p">[</span><span class="n">token</span><span class="p">],</span> <span class="s1">&#39;ExtraGrammatical&#39;</span><span class="p">,</span> <span class="n">substringrep</span><span class="p">,</span> <span class="s1">&#39;Tokenisation&#39;</span><span class="p">,</span>
                            <span class="n">subcat</span><span class="o">=</span><span class="n">repetition</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">repeatedtokens</span><span class="p">]</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>
    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">substringtokens</span><span class="p">]</span>

    <span class="c1"># simple duplicates</span>
    <span class="n">dupnodetokens</span> <span class="o">=</span> <span class="n">find_simpleduplicates</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">)</span>
    <span class="n">dupnodepositions</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">dupnodetokens</span><span class="p">]</span>
    <span class="n">repeatedtokens</span> <span class="o">=</span> <span class="n">getrepeatedtokens</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">dupnodetokens</span><span class="p">)</span>
    <span class="n">allremovetokens</span> <span class="o">+=</span> <span class="n">dupnodetokens</span>
    <span class="n">allremovepositions</span> <span class="o">+=</span> <span class="n">dupnodepositions</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">repeatedtokens</span><span class="p">[</span><span class="n">token</span><span class="p">],</span> <span class="s1">&#39;ExtraGrammatical&#39;</span><span class="p">,</span>
                            <span class="n">repeated</span><span class="p">,</span> <span class="s1">&#39;Tokenisation&#39;</span><span class="p">,</span> <span class="n">subcat</span><span class="o">=</span><span class="n">repetition</span><span class="p">)</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span>
                <span class="n">token</span> <span class="ow">in</span> <span class="n">repeatedtokens</span><span class="p">]</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>
    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dupnodetokens</span><span class="p">]</span>

    <span class="c1"># duplicate sequences</span>
    <span class="n">dupnodetokens</span><span class="p">,</span> <span class="n">dupinfo</span> <span class="o">=</span> <span class="n">find_duplicates2</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">)</span>
    <span class="n">dupnodepositions</span> <span class="o">=</span> <span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">dupnodetokens</span><span class="p">]</span>
    <span class="n">duppairs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">dupnodetokens</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">othertok</span> <span class="ow">in</span> <span class="n">reducedtokens</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="ow">in</span> <span class="n">dupinfo</span><span class="o">.</span><span class="n">longdups</span> <span class="ow">and</span> <span class="n">othertok</span><span class="o">.</span><span class="n">pos</span> <span class="o">==</span> <span class="n">dupinfo</span><span class="o">.</span><span class="n">longdups</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">]:</span>
                <span class="n">nwt</span> <span class="o">=</span> <span class="n">othertok</span>
                <span class="n">duppairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">nwt</span><span class="p">))</span>
                <span class="k">break</span>
    <span class="n">allremovetokens</span> <span class="o">+=</span> <span class="n">dupnodetokens</span>
    <span class="n">allremovepositions</span> <span class="o">+=</span> <span class="n">dupnodepositions</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">nwt</span><span class="p">,</span> <span class="s1">&#39;ExtraGrammatical&#39;</span><span class="p">,</span>
                            <span class="n">repeatedseqtoken</span><span class="p">,</span> <span class="s1">&#39;Tokenisation&#39;</span><span class="p">,</span> <span class="n">subcat</span><span class="o">=</span><span class="n">repetition</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">nwt</span> <span class="ow">in</span> <span class="n">duppairs</span><span class="p">]</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>
    <span class="n">reducedtokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tok</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">reducedtokens</span> <span class="k">if</span> <span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dupnodetokens</span><span class="p">]</span>

    <span class="c1"># remove unknown words if open class DO NOT DO this</span>
    <span class="c1"># unknown_word_tokens = [tok for tok in reducedtokens if getattval(token2nodemap[tok.pos], &#39;pt&#39;) in openclasspts</span>
    <span class="c1">#                        and not (asta_recognised_wordnode(token2nodemap[tok.pos]))]</span>
    <span class="c1"># unknown_word_positions = [token.pos for token in unknown_word_tokens]</span>
    <span class="c1"># allremovetokens += unknown_word_tokens</span>
    <span class="c1"># allremovepositions += unknown_word_positions</span>
    <span class="c1"># metadata = [mkSASTAMeta(token, token, &#39;ExtraGrammatical&#39;,</span>
    <span class="c1">#                         unknownword, &#39;Tokenisation&#39;)</span>
    <span class="c1">#             for token in reducedtokens if token in unknown_word_tokens]</span>
    <span class="c1"># allmetadata += metadata</span>
    <span class="c1"># reducedtokens = [n for n in reducedtokens if n not in unknown_word_tokens]</span>

    <span class="c1"># ngram based cases</span>

    <span class="c1"># vnw pv vnw pv</span>

    <span class="k">def</span> <span class="nf">metaf</span><span class="p">(</span><span class="n">falsestarttokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">falsestartpositions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Position</span><span class="p">],</span> <span class="n">correcttokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">])</span> \
            <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Meta</span><span class="p">]:</span>
        <span class="k">return</span> \
            <span class="p">[</span><span class="n">Meta</span><span class="p">(</span><span class="s1">&#39;Retracing&#39;</span><span class="p">,</span> <span class="s1">&#39;Retracing with Correction&#39;</span><span class="p">,</span> <span class="n">annotatedposlist</span><span class="o">=</span><span class="n">falsestartpositions</span><span class="p">,</span>
                  <span class="n">annotatedwordlist</span><span class="o">=</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">word</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">falsestarttokens</span><span class="p">],</span>
                  <span class="n">annotationposlist</span><span class="o">=</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">pos</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">correcttokens</span><span class="p">],</span>
                  <span class="n">annotationwordlist</span><span class="o">=</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">word</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">correcttokens</span><span class="p">],</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Retracing&#39;</span><span class="p">,</span> <span class="n">subcat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">SASTA</span><span class="p">,</span>
                  <span class="n">penalty</span><span class="o">=</span><span class="n">defaultpenalty</span><span class="p">,</span> <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_none</span><span class="p">)]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">ftoken</span><span class="p">,</span> <span class="n">ctoken</span><span class="p">,</span> <span class="s1">&#39;Retracing with Correction&#39;</span><span class="p">,</span> <span class="n">fstoken</span><span class="p">,</span> <span class="s1">&#39;Retracing&#39;</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">ftoken</span><span class="p">,</span> <span class="n">ctoken</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">falsestarttokens</span><span class="p">,</span> <span class="n">correcttokens</span><span class="p">)]</span>

    <span class="n">vnwpvvnwpvcor</span> <span class="o">=</span> <span class="n">Ngramcorrection</span><span class="p">(</span><span class="n">ngram1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">metaf</span><span class="p">)</span>
    <span class="n">reducedtokens</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span> <span class="n">allmetadata</span> <span class="o">=</span> <span class="n">ngramreduction</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">token2nodemap</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span>
                                                                 <span class="n">allremovepositions</span><span class="p">,</span> <span class="n">allmetadata</span><span class="p">,</span> <span class="n">vnwpvvnwpvcor</span><span class="p">)</span>

    <span class="n">vzdetvzdetcor</span> <span class="o">=</span> <span class="n">Ngramcorrection</span><span class="p">(</span><span class="n">ngram2</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">metaf</span><span class="p">)</span>
    <span class="n">reducedtokens</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span> <span class="n">allmetadata</span> <span class="o">=</span> <span class="n">ngramreduction</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">token2nodemap</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span>
                                                                 <span class="n">allremovepositions</span><span class="p">,</span> <span class="n">allmetadata</span><span class="p">,</span> <span class="n">vzdetvzdetcor</span><span class="p">)</span>

    <span class="n">vgdetvgdetcor</span> <span class="o">=</span> <span class="n">Ngramcorrection</span><span class="p">(</span><span class="n">ngram7</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">metaf</span><span class="p">)</span>
    <span class="n">reducedtokens</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span> <span class="n">allmetadata</span> <span class="o">=</span> <span class="n">ngramreduction</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">token2nodemap</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span>
                                                                 <span class="n">allremovepositions</span><span class="p">,</span> <span class="n">allmetadata</span><span class="p">,</span> <span class="n">vgdetvgdetcor</span><span class="p">)</span>
    <span class="n">vnwipvjxpvjvnwi</span> <span class="o">=</span> <span class="n">Ngramcorrection</span><span class="p">(</span><span class="n">ngram10</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">metaf</span><span class="p">)</span>
    <span class="n">reducedtokens</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span> <span class="n">allmetadata</span> <span class="o">=</span> <span class="n">ngramreduction</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">token2nodemap</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span>
                                                                 <span class="n">allremovepositions</span><span class="p">,</span> <span class="n">allmetadata</span><span class="p">,</span> <span class="n">vnwipvjxpvjvnwi</span><span class="p">)</span>
    <span class="n">lemilemjlemilemj</span> <span class="o">=</span> <span class="n">Ngramcorrection</span><span class="p">(</span><span class="n">ngram11</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">metaf</span><span class="p">)</span>
    <span class="n">reducedtokens</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span> <span class="n">allmetadata</span> <span class="o">=</span> <span class="n">ngramreduction</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">token2nodemap</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span>
                                                                 <span class="n">allremovepositions</span><span class="p">,</span> <span class="n">allmetadata</span><span class="p">,</span> <span class="n">lemilemjlemilemj</span><span class="p">)</span>

    <span class="n">dinjdknj</span> <span class="o">=</span> <span class="n">Ngramcorrection</span><span class="p">(</span><span class="n">ngram16</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">metaf</span><span class="p">)</span>
    <span class="n">reducedtokens</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span> <span class="n">allmetadata</span> <span class="o">=</span> <span class="n">ngramreduction</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">token2nodemap</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span>
                                                                 <span class="n">allremovepositions</span><span class="p">,</span> <span class="n">allmetadata</span><span class="p">,</span> <span class="n">dinjdknj</span><span class="p">)</span>

    <span class="n">tevtev</span> <span class="o">=</span> <span class="n">Ngramcorrection</span><span class="p">(</span><span class="n">ngram17</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">metaf</span><span class="p">)</span>
    <span class="n">reducedtokens</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span> <span class="n">allmetadata</span> <span class="o">=</span> <span class="n">ngramreduction</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="n">token2nodemap</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">,</span>
                                                                 <span class="n">allremovepositions</span><span class="p">,</span> <span class="n">allmetadata</span><span class="p">,</span> <span class="n">tevtev</span><span class="p">)</span>

    <span class="c1"># reducedleaves = [token2nodemap[tok.pos] for tok in reducedtokens]</span>
    <span class="c1">#</span>
    <span class="c1"># vnwpvvnwpvmatches = findmatches(ngram1, reducedleaves)</span>
    <span class="c1"># allfalsestarttokens = []</span>
    <span class="c1"># metadata = []</span>
    <span class="c1"># for match in vnwpvvnwpvmatches:</span>
    <span class="c1">#     positions = [pos for pos in range(match[0], match[1])]</span>
    <span class="c1">#     falsestartpositions = [tok.pos for i, tok in enumerate(reducedtokens) if i in positions[0:2]]</span>
    <span class="c1">#     falsestarttokens = [tok for tok in reducedtokens if tok.pos in falsestartpositions]</span>
    <span class="c1">#     allfalsestarttokens += falsestarttokens</span>
    <span class="c1">#     correcttokenpositions = [tok.pos for i, tok in enumerate(reducedtokens) if i in positions[2:5]]</span>
    <span class="c1">#     correcttokens = [tok for tok in reducedtokens if tok.pos in correcttokenpositions]</span>
    <span class="c1">#     allremovetokens += falsestarttokens</span>
    <span class="c1">#     allremovepositions += falsestartpositions</span>
    <span class="c1">#     metadata += [Meta(&#39;Retracing&#39;, &#39;Retracing with Correction&#39;,  annotatedposlist=falsestartpositions,</span>
    <span class="c1">#                  annotatedwordlist=[c.word for c in falsestarttokens], annotationposlist=[c.pos for c in correcttokens],</span>
    <span class="c1">#                  annotationwordlist=[c.word for c in correcttokens], cat=&#39;Retracing&#39;, subcat=None, source=SASTA,</span>
    <span class="c1">#                     penalty=defaultpenalty, backplacement=bpl_none)]</span>
    <span class="c1">#     metadata += [mkSASTAMeta(ftoken, ctoken, &#39;Retracing with Correction&#39;, fstoken,  &#39;Retracing&#39;, )</span>
    <span class="c1">#                 for ftoken, ctoken  in zip(falsestarttokens, correcttokens)]</span>
    <span class="c1">#</span>
    <span class="c1"># reducedtokens = [tok for tok in reducedtokens if tok not in allfalsestarttokens]</span>
    <span class="c1"># allmetadata += metadata</span>

    <span class="n">skipmarkedtokens</span> <span class="o">=</span> <span class="n">skiptokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">allremovetokens</span><span class="p">)</span>

    <span class="c1"># return (reducedtokens, allremovetokens, allmetadata)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">skipmarkedtokens</span><span class="p">,</span> <span class="n">allmetadata</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">keycheck</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">SDLOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;key </span><span class="si">{}</span><span class="s1">  not in dictionary. Contents of dictionary:&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">akey</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">valbgn</span> <span class="o">=</span> <span class="n">getattval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;begin&#39;</span><span class="p">)</span>
            <span class="n">valpt</span> <span class="o">=</span> <span class="n">getattval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;pt&#39;</span><span class="p">)</span>
            <span class="n">valword</span> <span class="o">=</span> <span class="n">getattval</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s1">&#39;word&#39;</span><span class="p">)</span>
            <span class="n">valstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valbgn</span><span class="p">,</span> <span class="n">valpt</span><span class="p">,</span> <span class="n">valword</span><span class="p">)</span>
            <span class="n">SDLOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">akey</span><span class="p">,</span> <span class="n">valstr</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">dict</span>


<span class="k">def</span> <span class="nf">combinesorted</span><span class="p">(</span><span class="n">toklist1</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">toklist2</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">toklist1</span> <span class="o">+</span> <span class="n">toklist2</span>
    <span class="n">sortedresult</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">tok</span><span class="p">:</span> <span class="n">tok</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sortedresult</span>


<span class="c1"># def getcorrection(utt, tree=None, interactive=False):</span>
<span class="c1">#     # NOT used anymore!!!!</span>
<span class="c1">#</span>
<span class="c1">#     allmetadata = []</span>
<span class="c1">#     rawtokens = sasta_tokenize(utt)</span>
<span class="c1">#     wordlist = tokenlist2stringlist(rawtokens)</span>
<span class="c1">#</span>
<span class="c1">#     tokens, metadata = cleantokens(rawtokens, repkeep=False)</span>
<span class="c1">#     allmetadata += metadata</span>
<span class="c1">#     tokensmd = TokenListMD(tokens, [])</span>
<span class="c1">#</span>
<span class="c1">#     # reducedtokens, allremovedtokens, metadata = reduce(tokens)</span>
<span class="c1">#     # allremovedtokens, metadata = reduce(tokens)</span>
<span class="c1">#     skipmarkedtokens, metadata = reduce(tokens, tree)</span>
<span class="c1">#     # reducedtokensmd = TokenListMD(reducedtokens, [])</span>
<span class="c1">#     reducedtokensmd = TokenListMD(skipmarkedtokens, [])</span>
<span class="c1">#</span>
<span class="c1">#     alternativemds = getalternatives(reducedtokensmd, tree, 0)</span>
<span class="c1">#     # alternativemds = getalternatives(tokensmd, allremovedtokens, tree, 0)</span>
<span class="c1">#     # unreducedalternativesmd = [TokenListMD(combinesorted(alternativemd.tokens, allremovedtokens), alternativemd.metadata) for alternativemd in alternativemds]</span>
<span class="c1">#</span>
<span class="c1">#     # correctiontokensmd = unreducedalternativesmd[-1] if unreducedalternativesmd != [] else tokensmd</span>
<span class="c1">#     correctiontokensmd = alternativemds[-1] if alternativemds != [] else tokensmd</span>
<span class="c1">#</span>
<span class="c1">#     correction = tokenlist2stringlist(correctiontokensmd.tokens)</span>
<span class="c1">#     allmetadata += correctiontokensmd.metadata</span>
<span class="c1">#</span>
<span class="c1">#     result = (correction, allmetadata)</span>
<span class="c1">#     return result</span>


<span class="k">def</span> <span class="nf">getcorrections</span><span class="p">(</span><span class="n">rawtokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">method</span><span class="p">:</span> <span class="n">MethodName</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SynTree</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">interactive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Correction</span><span class="p">]:</span>
    <span class="n">allmetadata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># rawtokens = sasta_tokenize(utt)</span>
    <span class="n">wordlist</span> <span class="o">=</span> <span class="n">tokenlist2stringlist</span><span class="p">(</span><span class="n">rawtokens</span><span class="p">)</span>
    <span class="n">utt</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wordlist</span><span class="p">)</span>
    <span class="n">origutt</span> <span class="o">=</span> <span class="n">utt</span>
    <span class="c1">#print(utt)</span>

    <span class="c1"># check whether the tree has the same yield</span>
    <span class="n">origtree</span> <span class="o">=</span> <span class="n">tree</span>
    <span class="n">treeyield</span> <span class="o">=</span> <span class="n">getnodeyield</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">treewordlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">getattval</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;word&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">treeyield</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">treewordlist</span> <span class="o">!=</span> <span class="n">wordlist</span><span class="p">:</span>
        <span class="n">revisedutt</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wordlist</span><span class="p">)</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">fatparse</span><span class="p">(</span><span class="n">revisedutt</span><span class="p">,</span> <span class="n">rawtokens</span><span class="p">)</span>

    <span class="n">tokens</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">cleantokens</span><span class="p">(</span><span class="n">rawtokens</span><span class="p">,</span> <span class="n">repkeep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>
    <span class="n">tokensmd</span> <span class="o">=</span> <span class="n">TokenListMD</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># reducedtokens, allremovedtokens, metadata = reduce(tokens)</span>
    <span class="n">reducedtokens</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>
    <span class="n">reducedtokensmd</span> <span class="o">=</span> <span class="n">TokenListMD</span><span class="p">(</span><span class="n">reducedtokens</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">allmetadata</span> <span class="o">+=</span> <span class="n">metadata</span>

    <span class="c1"># alternativemds = getalternatives(reducedtokensmd, tree, 0)</span>
    <span class="n">alternativemds</span> <span class="o">=</span> <span class="n">getalternatives</span><span class="p">(</span><span class="n">reducedtokensmd</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
    <span class="c1"># unreducedalternativesmd = [TokenListMD(combinesorted(alternativemd.tokens, allremovedtokens), alternativemd.metadata) for alternativemd in alternativemds]</span>

    <span class="n">intermediateresults</span> <span class="o">=</span> <span class="n">alternativemds</span> <span class="k">if</span> <span class="n">alternativemds</span> <span class="o">!=</span> <span class="p">[]</span> <span class="k">else</span> <span class="p">[</span><span class="n">tokensmd</span><span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ctmd</span> <span class="ow">in</span> <span class="n">intermediateresults</span><span class="p">:</span>
        <span class="c1"># correction = tokenlist2stringlist(ctmd.tokens)</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="n">ctmd</span><span class="o">.</span><span class="n">tokens</span>
        <span class="n">themetadata</span> <span class="o">=</span> <span class="n">allmetadata</span> <span class="o">+</span> <span class="n">ctmd</span><span class="o">.</span><span class="n">metadata</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">correction</span><span class="p">,</span> <span class="n">themetadata</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="c1"># def getalternatives(origtokensmd, method, llremovedtokens, tree, uttid):</span>
<span class="k">def</span> <span class="nf">getalternatives</span><span class="p">(</span><span class="n">origtokensmd</span><span class="p">:</span> <span class="n">TokenListMD</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">MethodName</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">SynTree</span><span class="p">,</span> <span class="n">uttid</span><span class="p">:</span> <span class="n">UttId</span><span class="p">):</span>
    <span class="n">tokensmd</span> <span class="o">=</span> <span class="n">explanationasreplacement</span><span class="p">(</span><span class="n">origtokensmd</span><span class="p">,</span> <span class="n">tree</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tokensmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tokensmd</span> <span class="o">=</span> <span class="n">origtokensmd</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokensmd</span><span class="o">.</span><span class="n">tokens</span>
    <span class="n">allmetadata</span> <span class="o">=</span> <span class="n">tokensmd</span><span class="o">.</span><span class="n">metadata</span>
    <span class="c1">#newtokens = []</span>
    <span class="c1">#alternatives = []</span>
    <span class="n">alternativetokenmds</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">validalternativetokenmds</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tokenctr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="n">tokenmd</span> <span class="o">=</span> <span class="n">TokenMD</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">allmetadata</span><span class="p">)</span>
        <span class="n">alternativetokenmds</span><span class="p">[</span><span class="n">tokenctr</span><span class="p">]</span> <span class="o">=</span> <span class="n">getalternativetokenmds</span><span class="p">(</span><span class="n">tokenmd</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">tokenctr</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">uttid</span><span class="p">)</span>
        <span class="n">validalternativetokenmds</span><span class="p">[</span><span class="n">tokenctr</span><span class="p">]</span> <span class="o">=</span> <span class="n">getvalidalternativetokenmds</span><span class="p">(</span><span class="n">tokenmd</span><span class="p">,</span> <span class="n">alternativetokenmds</span><span class="p">[</span><span class="n">tokenctr</span><span class="p">])</span>
        <span class="n">tokenctr</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># get all the new token sequences</span>
    <span class="n">tokenctr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">lvalidalternativetokenmds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">validalternativetokenmds</span><span class="p">)</span>
    <span class="n">altutts</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">TokenMD</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[[]]</span>
    <span class="n">newutts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">tokenctr</span> <span class="o">&lt;</span> <span class="n">lvalidalternativetokenmds</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tokenmd</span> <span class="ow">in</span> <span class="n">validalternativetokenmds</span><span class="p">[</span><span class="n">tokenctr</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">utt</span> <span class="ow">in</span> <span class="n">altutts</span><span class="p">:</span>
                <span class="n">newutt</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">utt</span><span class="p">)</span>
                <span class="n">newutt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokenmd</span><span class="p">)</span>
                <span class="n">newutts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newutt</span><span class="p">)</span>
        <span class="n">altutts</span> <span class="o">=</span> <span class="n">newutts</span>
        <span class="n">newutts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tokenctr</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># now turn each sequence of (token, md) pairs into a pair (tokenlist, mergedmetadata)</span>
    <span class="n">newaltuttmds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">altuttmd</span> <span class="ow">in</span> <span class="n">altutts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">altuttmd</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">newaltuttmd</span> <span class="o">=</span> <span class="n">mdlist2listmd</span><span class="p">(</span><span class="n">altuttmd</span><span class="p">)</span>
            <span class="n">newaltuttmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newaltuttmd</span><span class="p">)</span>

    <span class="c1"># basic expansions</span>

    <span class="n">allalternativemds</span> <span class="o">=</span> <span class="n">newaltuttmds</span>

    <span class="n">newresults</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">uttmd</span> <span class="ow">in</span> <span class="n">allalternativemds</span><span class="p">:</span>
        <span class="n">expansionmds</span> <span class="o">=</span> <span class="n">getexpansions</span><span class="p">(</span><span class="n">uttmd</span><span class="p">)</span>
        <span class="n">newresults</span> <span class="o">+=</span> <span class="n">expansionmds</span>
    <span class="n">allalternativemds</span> <span class="o">+=</span> <span class="n">newresults</span>

    <span class="c1"># combinations of tokens or their alternatives: de kopje, de stukkie, heeft gevalt</span>

    <span class="n">newresults</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">uttmd</span> <span class="ow">in</span> <span class="n">allalternativemds</span><span class="p">:</span>
        <span class="c1"># utterance = space.join([token.word for token in uttmd.tokens])</span>
        <span class="n">utterance</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mkuttwithskips</span><span class="p">(</span><span class="n">uttmd</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">fatntree</span> <span class="o">=</span> <span class="n">fatparse</span><span class="p">(</span><span class="n">utterance</span><span class="p">,</span> <span class="n">uttmd</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">newresults</span> <span class="o">+=</span> <span class="n">getwrongdetalternatives</span><span class="p">(</span><span class="n">uttmd</span><span class="p">,</span> <span class="n">fatntree</span><span class="p">,</span> <span class="n">uttid</span><span class="p">)</span>
    <span class="n">allalternativemds</span> <span class="o">+=</span> <span class="n">newresults</span>

    <span class="n">newresults</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">uttmd</span> <span class="ow">in</span> <span class="n">allalternativemds</span><span class="p">:</span>
        <span class="c1"># utterance = space.join([token.word for token in uttmd.tokens])</span>
        <span class="n">utterance</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mkuttwithskips</span><span class="p">(</span><span class="n">uttmd</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
        <span class="c1"># reducedtokens = [t for t in uttmd.tokens if not t.skip]</span>
        <span class="c1"># reduceduttmd = TokenListMD(reducedtokens, uttmd.metadata)</span>
        <span class="n">fatntree</span> <span class="o">=</span> <span class="n">fatparse</span><span class="p">(</span><span class="n">utterance</span><span class="p">,</span> <span class="n">uttmd</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">showtree</span><span class="p">(</span><span class="n">fatntree</span><span class="p">)</span>
        <span class="n">uttalternativemds</span> <span class="o">=</span> <span class="n">getsvacorrections</span><span class="p">(</span><span class="n">uttmd</span><span class="p">,</span> <span class="n">fatntree</span><span class="p">,</span> <span class="n">uttid</span><span class="p">)</span>
        <span class="n">newresults</span> <span class="o">+=</span> <span class="n">uttalternativemds</span>
    <span class="n">allalternativemds</span> <span class="o">+=</span> <span class="n">newresults</span>

    <span class="n">newresults</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">uttmd</span> <span class="ow">in</span> <span class="n">allalternativemds</span><span class="p">:</span>
        <span class="c1"># utterance = space.join([token.word for token in uttmd.tokens])</span>
        <span class="n">utterance</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mkuttwithskips</span><span class="p">(</span><span class="n">uttmd</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">fatntree</span> <span class="o">=</span> <span class="n">fatparse</span><span class="p">(</span><span class="n">utterance</span><span class="p">,</span> <span class="n">uttmd</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">newresults</span> <span class="o">+=</span> <span class="n">correctPdit</span><span class="p">(</span><span class="n">uttmd</span><span class="p">,</span> <span class="n">fatntree</span><span class="p">,</span> <span class="n">uttid</span><span class="p">)</span>
    <span class="n">allalternativemds</span> <span class="o">+=</span> <span class="n">newresults</span>

    <span class="n">newresults</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">uttmd</span> <span class="ow">in</span> <span class="n">allalternativemds</span><span class="p">:</span>
        <span class="n">utterance</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mkuttwithskips</span><span class="p">(</span><span class="n">uttmd</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">fatntree</span> <span class="o">=</span> <span class="n">fatparse</span><span class="p">(</span><span class="n">utterance</span><span class="p">,</span> <span class="n">uttmd</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span>
        <span class="n">newresults</span> <span class="o">+=</span> <span class="n">smallclauses</span><span class="p">(</span><span class="n">uttmd</span><span class="p">,</span> <span class="n">fatntree</span><span class="p">)</span>
        <span class="c1"># showtree(fatntree, text=&#39;fatntree&#39;)</span>
    <span class="n">allalternativemds</span> <span class="o">+=</span> <span class="n">newresults</span>

    <span class="c1"># final check whether the alternatives are improvements. It is not assumed that the original tokens is included in the alternatives</span>
    <span class="n">finalalternativemds</span> <span class="o">=</span> <span class="n">lexcheck</span><span class="p">(</span><span class="n">tokensmd</span><span class="p">,</span> <span class="n">allalternativemds</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">finalalternativemds</span>


<span class="n">skiptemplate</span> <span class="o">=</span> <span class="s2">&quot;[ @skip </span><span class="si">{}</span><span class="s2"> ]&quot;</span>


<span class="k">def</span> <span class="nf">oldmkuttwithskips</span><span class="p">(</span><span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">toskip</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">sortedtokens</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">resultlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sortedtokens</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">toskip</span><span class="p">:</span>
            <span class="n">resultlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skiptemplate</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resultlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resultlist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">mkuttwithskips</span><span class="p">(</span><span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">delete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Position</span><span class="p">]]:</span>
    <span class="n">sortedtokens</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">resultlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tokenposlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sortedtokens</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">delete</span><span class="p">:</span>
                <span class="n">resultlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skiptemplate</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">))</span>
                <span class="n">tokenposlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resultlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
            <span class="n">tokenposlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resultlist</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">tokenposlist</span>


<span class="k">def</span> <span class="nf">oldgetexpansions</span><span class="p">(</span><span class="n">uttmd</span><span class="p">:</span> <span class="n">TokenListMD</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenListMD</span><span class="p">]:</span>
    <span class="n">newtokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tokenctr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">newtokenctr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tokenposlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">newmd</span> <span class="o">=</span> <span class="n">uttmd</span><span class="o">.</span><span class="n">metadata</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">uttmd</span><span class="o">.</span><span class="n">tokens</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">basicexpansions</span><span class="p">:</span>
            <span class="n">expansionfound</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">rlist</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">basicexpansions</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()]:</span>
                <span class="k">for</span> <span class="n">rw</span> <span class="ow">in</span> <span class="n">rlist</span><span class="p">:</span>
                    <span class="n">newtoken</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">newtokenctr</span><span class="p">)</span>
                    <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newtoken</span><span class="p">)</span>
                    <span class="n">tokenposlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                    <span class="n">newtokenctr</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">nwt</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">space</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rlist</span><span class="p">),</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">meta1</span> <span class="o">=</span> <span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">nwt</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">subcat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="n">defaultpenalty</span><span class="p">,</span>
                                    <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_none</span><span class="p">)</span>
                <span class="n">newmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">newtoken</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">,</span> <span class="n">newtokenctr</span><span class="p">)</span>
            <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newtoken</span><span class="p">)</span>
            <span class="n">tokenposlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">tokenctr</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">newtokenctr</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># adapt the metadata</span>
    <span class="k">if</span> <span class="n">expansionfound</span><span class="p">:</span>
        <span class="n">meta2</span> <span class="o">=</span> <span class="n">Meta</span><span class="p">(</span><span class="s1">&#39;OrigCleanTokenPosList&#39;</span><span class="p">,</span> <span class="n">tokenposlist</span><span class="p">,</span> <span class="n">annotatedposlist</span><span class="o">=</span><span class="p">[],</span>
                     <span class="n">annotatedwordlist</span><span class="o">=</span><span class="p">[],</span> <span class="n">annotationposlist</span><span class="o">=</span><span class="n">tokenposlist</span><span class="p">,</span>
                     <span class="n">annotationwordlist</span><span class="o">=</span><span class="p">[],</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Tokenisation&#39;</span><span class="p">,</span> <span class="n">subcat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">SASTA</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="n">defaultpenalty</span><span class="p">,</span>
                     <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_none</span><span class="p">)</span>
        <span class="n">newmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta2</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">TokenListMD</span><span class="p">(</span><span class="n">newtokens</span><span class="p">,</span> <span class="n">newmd</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">getexpansions</span><span class="p">(</span><span class="n">uttmd</span><span class="p">:</span> <span class="n">TokenListMD</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenListMD</span><span class="p">]:</span>
    <span class="n">expansionfound</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">newtokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tokenctr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">#newtokenctr = 0</span>
    <span class="n">tokenposlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">newmd</span> <span class="o">=</span> <span class="n">uttmd</span><span class="o">.</span><span class="n">metadata</span>
    <span class="k">for</span> <span class="n">tokenctr</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">uttmd</span><span class="o">.</span><span class="n">tokens</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">basicexpansions</span><span class="p">:</span>
            <span class="n">expansionfound</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">rlist</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">basicexpansions</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()]:</span>
                <span class="n">rlisttokenctr</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">rlisttokenctr</span><span class="p">,</span> <span class="n">rw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rlist</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">rlisttokenctr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">newtoken</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">newtoken</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">rw</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">subpos</span><span class="o">=</span><span class="n">rlisttokenctr</span><span class="p">)</span>
                    <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newtoken</span><span class="p">)</span>
                    <span class="n">tokenposlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                    <span class="n">nwt</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">space</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rlist</span><span class="p">),</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                <span class="n">meta1</span> <span class="o">=</span> <span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">nwt</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">subcat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="n">defaultpenalty</span><span class="p">,</span>
                                    <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_none</span><span class="p">)</span>
                <span class="n">newmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta1</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">newtoken</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newtoken</span><span class="p">)</span>
            <span class="n">tokenposlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

    <span class="c1"># adapt the metadata</span>
    <span class="k">if</span> <span class="n">expansionfound</span><span class="p">:</span>
        <span class="n">meta2</span> <span class="o">=</span> <span class="n">Meta</span><span class="p">(</span><span class="s1">&#39;OrigCleanTokenPosList&#39;</span><span class="p">,</span> <span class="n">tokenposlist</span><span class="p">,</span> <span class="n">annotatedposlist</span><span class="o">=</span><span class="p">[],</span>
                     <span class="n">annotatedwordlist</span><span class="o">=</span><span class="p">[],</span> <span class="n">annotationposlist</span><span class="o">=</span><span class="n">tokenposlist</span><span class="p">,</span>
                     <span class="n">annotationwordlist</span><span class="o">=</span><span class="p">[],</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Tokenisation&#39;</span><span class="p">,</span> <span class="n">subcat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">SASTA</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="n">defaultpenalty</span><span class="p">,</span>
                     <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_none</span><span class="p">)</span>
        <span class="n">newmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta2</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">TokenListMD</span><span class="p">(</span><span class="n">newtokens</span><span class="p">,</span> <span class="n">newmd</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">lexcheck</span><span class="p">(</span><span class="n">intokensmd</span><span class="p">:</span> <span class="n">TokenListMD</span><span class="p">,</span> <span class="n">allalternativemds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenListMD</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenListMD</span><span class="p">]:</span>
    <span class="n">finalalternativemds</span> <span class="o">=</span> <span class="p">[</span><span class="n">intokensmd</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">alternativemd</span> <span class="ow">in</span> <span class="n">allalternativemds</span><span class="p">:</span>
        <span class="n">diff_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">include</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">intokens</span> <span class="o">=</span> <span class="n">intokensmd</span><span class="o">.</span><span class="n">tokens</span>
        <span class="n">outtokens</span> <span class="o">=</span> <span class="n">alternativemd</span><span class="o">.</span><span class="n">tokens</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intokens</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">outtokens</span><span class="p">):</span>
            <span class="n">diff_found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">intoken</span><span class="p">,</span> <span class="n">outtoken</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">intokens</span><span class="p">,</span> <span class="n">outtokens</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">intoken</span> <span class="o">!=</span> <span class="n">outtoken</span><span class="p">:</span>
                    <span class="n">diff_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">known_word</span><span class="p">(</span><span class="n">outtoken</span><span class="o">.</span><span class="n">word</span><span class="p">):</span>
                        <span class="n">include</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="n">diff_found</span> <span class="ow">and</span> <span class="n">include</span><span class="p">:</span>
            <span class="n">finalalternativemds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alternativemd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">finalalternativemds</span>


<span class="c1"># moved to metadata</span>
<span class="c1"># def mkSASTAMeta(token, nwt, name, value, cat, subcat=None, penalty=defaultpenalty, backplacement=defaultbackplacement):</span>
<span class="c1">#    result = Meta(name, value, annotatedposlist=[token.pos],</span>
<span class="c1">#                     annotatedwordlist=[token.word], annotationposlist=[nwt.pos],</span>
<span class="c1">#                     annotationwordlist=[nwt.word], cat=cat, subcat=subcat, source=SASTA, penalty=penalty,</span>
<span class="c1">#                     backplacement=backplacement)</span>
<span class="c1">#    return result</span>


<span class="k">def</span> <span class="nf">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenMD</span><span class="p">],</span> <span class="n">token</span><span class="p">:</span> <span class="n">Token</span><span class="p">,</span> <span class="n">newwords</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">beginmetadata</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Meta</span><span class="p">],</span> \
                       <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cat</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">subcat</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">penalty</span><span class="p">:</span> <span class="n">Penalty</span> <span class="o">=</span> <span class="n">defaultpenalty</span><span class="p">,</span> <span class="n">backplacement</span><span class="p">:</span> <span class="n">BackPlacement</span> <span class="o">=</span> <span class="n">defaultbackplacement</span><span class="p">)</span> \
                <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenMD</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">nw</span> <span class="ow">in</span> <span class="n">newwords</span><span class="p">:</span>
        <span class="n">nwt</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">nw</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">nwt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">subcat</span><span class="o">=</span><span class="n">subcat</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="n">penalty</span><span class="p">,</span>
                           <span class="n">backplacement</span><span class="o">=</span><span class="n">backplacement</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">[</span><span class="n">meta</span><span class="p">]</span> <span class="o">+</span> <span class="n">beginmetadata</span>
        <span class="n">newwordtokenmd</span> <span class="o">=</span> <span class="n">TokenMD</span><span class="p">(</span><span class="n">nwt</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
        <span class="n">newtokenmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newwordtokenmd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newtokenmds</span>


<span class="k">def</span> <span class="nf">gettokensplusxmeta</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">SynTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Meta</span><span class="p">]]:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    converts the origutt into  list of xmeta elements</span>
<span class="sd">    :param tree: input tree</span>
<span class="sd">    :return: list of xmeta elements</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">origutt</span> <span class="o">=</span> <span class="n">find1</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="s1">&#39;.//meta[@name=&quot;origutt&quot;]/@value&#39;</span><span class="p">)</span>
    <span class="n">tokens1</span> <span class="o">=</span> <span class="n">sasta_tokenize</span><span class="p">(</span><span class="n">origutt</span><span class="p">)</span>
    <span class="n">tokens2</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">cleantokens</span><span class="p">(</span><span class="n">tokens1</span><span class="p">,</span> <span class="n">repkeep</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tokens2</span><span class="p">,</span> <span class="n">metadata</span>


<span class="k">def</span> <span class="nf">findxmetaatt</span><span class="p">(</span><span class="n">xmetalist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Meta</span><span class="p">],</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cond</span><span class="p">:</span> <span class="n">MetaCondition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Meta</span><span class="p">]:</span>
    <span class="n">cands</span> <span class="o">=</span> <span class="p">[</span><span class="n">xm</span> <span class="k">for</span> <span class="n">xm</span> <span class="ow">in</span> <span class="n">xmetalist</span> <span class="k">if</span> <span class="n">xm</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">cond</span><span class="p">(</span><span class="n">xm</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">cands</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">tokenreplace</span><span class="p">(</span><span class="n">oldtokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">newtoken</span><span class="p">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">]:</span>
    <span class="n">newtokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">oldtokens</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="o">==</span> <span class="n">newtoken</span><span class="o">.</span><span class="n">pos</span><span class="p">:</span>
            <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newtoken</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newtokens</span>


<span class="k">def</span> <span class="nf">explanationasreplacement</span><span class="p">(</span><span class="n">tokensmd</span><span class="p">:</span> <span class="n">TokenListMD</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">SynTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TokenListMD</span><span class="p">]:</span>
    <span class="c1"># interpret single word explanation as replacement # this will work only after retokenistion of the origutt</span>
    <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">origmetadata</span> <span class="o">=</span> <span class="n">tokensmd</span><span class="o">.</span><span class="n">metadata</span>
    <span class="n">xtokens</span><span class="p">,</span> <span class="n">xmetalist</span> <span class="o">=</span> <span class="n">gettokensplusxmeta</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">explanations</span> <span class="o">=</span> <span class="p">[</span><span class="n">xm</span> <span class="k">for</span> <span class="n">xm</span> <span class="ow">in</span> <span class="n">xmetalist</span> <span class="k">if</span> <span class="n">xm</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;Explanation&#39;</span><span class="p">]</span>
    <span class="n">newtokens</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">xtokens</span><span class="p">)</span>
    <span class="n">newmetadata</span> <span class="o">=</span> <span class="n">origmetadata</span> <span class="o">+</span> <span class="n">xmetalist</span>
    <span class="k">for</span> <span class="n">explanation</span> <span class="ow">in</span> <span class="n">explanations</span><span class="p">:</span>
        <span class="n">newwordlist</span> <span class="o">=</span> <span class="n">explanation</span><span class="o">.</span><span class="n">annotationwordlist</span>
        <span class="n">oldwordlist</span> <span class="o">=</span> <span class="n">explanation</span><span class="o">.</span><span class="n">annotatedwordlist</span>
        <span class="n">tokenposlist</span> <span class="o">=</span> <span class="n">explanation</span><span class="o">.</span><span class="n">annotatedposlist</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newwordlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenposlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldwordlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">newword</span> <span class="o">=</span> <span class="n">newwordlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">oldwordpos</span> <span class="o">=</span> <span class="n">tokenposlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">oldword</span> <span class="o">=</span> <span class="n">oldwordlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">newtoken</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">newword</span><span class="p">,</span> <span class="n">oldwordpos</span><span class="p">)</span>
            <span class="n">oldtoken</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">oldword</span><span class="p">,</span> <span class="n">oldwordpos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">known_word</span><span class="p">(</span><span class="n">newword</span><span class="p">):</span>
                <span class="n">newtokens</span> <span class="o">=</span> <span class="n">tokenreplace</span><span class="p">(</span><span class="n">newtokens</span><span class="p">,</span> <span class="n">newtoken</span><span class="p">)</span>
                <span class="n">bpl</span> <span class="o">=</span> <span class="n">bpl_node</span> <span class="k">if</span> <span class="n">known_word</span><span class="p">(</span><span class="n">oldword</span><span class="p">)</span> <span class="k">else</span> <span class="n">bpl_word</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">oldtoken</span><span class="p">,</span> <span class="n">newtoken</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ExplanationasReplacement&#39;</span><span class="p">,</span>
                                   <span class="n">value</span><span class="o">=</span><span class="s1">&#39;ExplanationasReplacement&#39;</span><span class="p">,</span>
                                   <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Lexical Error&#39;</span><span class="p">,</span> <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl</span><span class="p">)</span>
                <span class="n">newmetadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">TokenListMD</span><span class="p">(</span><span class="n">newtokens</span><span class="p">,</span> <span class="n">newmetadata</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="c1"># some words are known but very unlikely as such</span>
<span class="n">specialdevoicingwords</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fan&#39;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">initdevoicing</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="n">Token</span><span class="p">,</span> <span class="n">voiceless</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">voiced</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">newtokenmds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenMD</span><span class="p">],</span> <span class="n">beginmetadata</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Meta</span><span class="p">])</span> \
        <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenMD</span><span class="p">]:</span>
    <span class="c1"># initial s -&gt; z, f -&gt; v</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">known_word</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">specialdevoicingwords</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">voiceless</span><span class="p">:</span>
            <span class="n">newword</span> <span class="o">=</span> <span class="n">voiced</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">known_word</span><span class="p">(</span><span class="n">newword</span><span class="p">):</span>
                <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="p">[</span><span class="n">newword</span><span class="p">],</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pronunciation Variant&#39;</span><span class="p">,</span>
                                                <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Initial </span><span class="si">{}</span><span class="s1"> devoicing&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">voiced</span><span class="p">),</span>
                                                <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Pronunciation&#39;</span><span class="p">,</span> <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_word</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">newtokenmds</span>


<span class="k">def</span> <span class="nf">getalternativetokenmds</span><span class="p">(</span><span class="n">tokenmd</span><span class="p">:</span> <span class="n">TokenMD</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="n">MethodName</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Token</span><span class="p">],</span> <span class="n">tokenctr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> \
                           <span class="n">tree</span><span class="p">:</span> <span class="n">SynTree</span><span class="p">,</span> <span class="n">uttid</span><span class="p">:</span> <span class="n">UttId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenMD</span><span class="p">]:</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">tokenmd</span><span class="o">.</span><span class="n">token</span>
    <span class="n">beginmetadata</span> <span class="o">=</span> <span class="n">tokenmd</span><span class="o">.</span><span class="n">metadata</span>
    <span class="n">newtokenmds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenMD</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">newtokenmds</span>

    <span class="c1"># decapitalize initial token  except when it is a known name</span>
    <span class="k">if</span> <span class="n">tokenctr</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">istitle</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isa_namepart</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">):</span>
        <span class="n">newword</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="p">[</span><span class="n">newword</span><span class="p">],</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Character Case&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Lower case&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Orthography&#39;</span><span class="p">)</span>

    <span class="c1"># dehyphenate</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">known_word</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hyphen</span> <span class="ow">in</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">:</span>
        <span class="n">newwords</span> <span class="o">=</span> <span class="n">fullworddehyphenate</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">,</span> <span class="n">known_word</span><span class="p">)</span>
        <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">newwords</span><span class="p">,</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dehyphenation&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Dehyphenation&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Pronunciation&#39;</span><span class="p">,</span>
                                        <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_word</span><span class="p">)</span>

    <span class="c1"># deduplicate jaaaaa -&gt; ja; heeeeeel -&gt; heel</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">known_word</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">):</span>
        <span class="n">newwords</span> <span class="o">=</span> <span class="n">deduplicate</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">,</span> <span class="n">known_word</span><span class="p">,</span> <span class="n">exceptions</span><span class="o">=</span><span class="n">chatxxxcodes</span><span class="p">)</span>
        <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">newwords</span><span class="p">,</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Emphasis&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Phoneme lengthening&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Pronunciation&#39;</span><span class="p">,</span>
                                        <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_word</span><span class="p">)</span>

    <span class="c1"># basic replacements replace as by als, isse by is</span>
    <span class="c1"># here come the replacements</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">basicreplacements</span><span class="p">:</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">basicreplacements</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()]:</span>
            <span class="n">newwords</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">newwords</span><span class="p">,</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_word</span><span class="p">)</span>

    <span class="n">moemoetxpath</span> <span class="o">=</span> <span class="s1">&#39;.//node[@lemma=&quot;moe&quot; and @pt!=&quot;n&quot; and not(</span><span class="si">%o</span><span class="s1">nlywordinutt%) and (@rel=&quot;--&quot; or @rel=&quot;dp&quot; or @rel=&quot;predm&quot; or @rel=&quot;nucl&quot;)]&#39;</span>
    <span class="n">expanded_moemoetxpath</span> <span class="o">=</span> <span class="n">expandmacros</span><span class="p">(</span><span class="n">moemoetxpath</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;moe&#39;</span> <span class="ow">and</span> <span class="n">tree</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">expanded_moemoetxpath</span><span class="p">)</span> <span class="o">!=</span> <span class="p">[]:</span>
        <span class="n">newwords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;moet&#39;</span><span class="p">]</span>
        <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">newwords</span><span class="p">,</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Informal pronunciation&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Final t-deletion&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Pronunciation&#39;</span><span class="p">,</span>
                                        <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_word</span><span class="p">)</span>

    <span class="c1"># dee -&gt; deze of deed</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dee&#39;</span><span class="p">:</span>
        <span class="n">newwords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deze&#39;</span><span class="p">]</span>
        <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">newwords</span><span class="p">,</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Wrong pronunciation&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Coda reduction&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Pronunciation&#39;</span><span class="p">,</span>
                                        <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_word</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">newwords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;deed&#39;</span><span class="p">]</span>
        <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">newwords</span><span class="p">,</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Informal pronunciation&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Final t-deletion&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Pronunciation&#39;</span><span class="p">,</span>
                                        <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_word</span><span class="p">)</span>

    <span class="c1"># find document specific replacements</span>

    <span class="c1"># find organisation specific replacements</span>

    <span class="c1"># find childes replacements, preferably with vocabulary from the same age</span>

    <span class="c1"># gaatie</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">known_word</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">):</span>
        <span class="n">newwords</span> <span class="o">=</span> <span class="n">gaatie</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
        <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">newwords</span><span class="p">,</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Word combination&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Cliticisation&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Pronunciation&#39;</span><span class="p">,</span>
                                        <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_none</span><span class="p">)</span>

    <span class="c1"># extend to gaat-ie</span>

    <span class="c1"># dediacritisize</span>

    <span class="c1"># iedims</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;ie&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;ies&#39;</span><span class="p">):</span>
        <span class="n">newwords</span> <span class="o">=</span> <span class="n">getjeforms</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
        <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">newwords</span><span class="p">,</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;RegionalForm&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;ieDim&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Morphology&#39;</span><span class="p">,</span> <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_word</span><span class="p">)</span>

    <span class="c1"># overregularised verb forms: gevalt -&gt; gevallen including  incl  wrong verb forms: gekeekt -&gt; gekeken</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">known_word</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">):</span>
        <span class="n">nwms</span> <span class="o">=</span> <span class="n">correctinflection</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nw</span><span class="p">,</span> <span class="n">metavalue</span> <span class="ow">in</span> <span class="n">nwms</span><span class="p">:</span>
            <span class="n">newtokenmds</span> <span class="o">+=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="p">[</span><span class="n">nw</span><span class="p">],</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;InflectionError&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">metavalue</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Morphology&#39;</span><span class="p">,</span>
                                             <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_word</span><span class="p">)</span>

    <span class="c1"># wrong verb forms: gekeekt -&gt; gekeken: done!</span>

    <span class="c1"># me ze (grote/oudere/ kleine) moeder /vader/zusje/ broer -&gt; mijn me s done by Alpiono, here we do ze</span>
    <span class="c1"># next xpath does not work becasue it must be preceded by a . !!</span>
    <span class="c1"># zexpathmodel = &quot;&quot;&quot;//node[@word=&quot;ze&quot; and @begin={begin} and (@rel=&quot;--&quot;  or (@rel=&quot;obj1&quot; and parent::node[@cat=&quot;pp&quot;])) and @end = ancestor::node[@cat=&quot;top&quot;]/descendant::node[@pt=&quot;n&quot;]/@begin]&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ze&#39;</span> <span class="ow">or</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;su&#39;</span><span class="p">:</span>
        <span class="c1"># find the node that corresponds to this token in the tree</span>
        <span class="c1"># zexpath = zexpathmodel.format(begin=str(tokenctr))</span>
        <span class="c1"># zenode = find1(tree, zexpath)</span>
        <span class="n">tokennodes</span> <span class="o">=</span> <span class="n">getnodeyield</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="n">zenode</span> <span class="o">=</span> <span class="n">tokennodes</span><span class="p">[</span><span class="n">tokenctr</span><span class="p">]</span>
        <span class="n">nexttoken</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span>
            <span class="n">tokenctr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># do not take it from the tree because it may have been replaced by something else, e.g. avoid: ze dee -&gt; ze deed -/-&gt; z&#39;n deed!</span>
        <span class="n">zerel</span> <span class="o">=</span> <span class="n">getattval</span><span class="p">(</span><span class="n">zenode</span><span class="p">,</span> <span class="s1">&#39;rel&#39;</span><span class="p">)</span>
        <span class="n">zeparent</span> <span class="o">=</span> <span class="n">zenode</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span>
        <span class="n">zeparentcat</span> <span class="o">=</span> <span class="n">getattval</span><span class="p">(</span><span class="n">zeparent</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">)</span>
        <span class="c1"># nextpt = getattval(nextnode, &#39;pt&#39;)</span>
        <span class="n">nexttokeninfo</span> <span class="o">=</span> <span class="n">getwordinfo</span><span class="p">(</span><span class="n">nexttoken</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="n">nexttokenpts</span> <span class="o">=</span> <span class="p">{</span><span class="n">pt</span> <span class="k">for</span> <span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">nexttokeninfo</span><span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">zerel</span> <span class="o">==</span> <span class="s1">&#39;--&#39;</span> <span class="ow">or</span> <span class="n">zerel</span> <span class="o">==</span> <span class="s1">&#39;mwp&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">zerel</span> <span class="o">==</span> <span class="s1">&#39;obj1&#39;</span> <span class="ow">and</span> <span class="n">zeparentcat</span> <span class="o">==</span> <span class="s1">&#39;pp&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="s1">&#39;n&#39;</span> <span class="ow">in</span> <span class="n">nexttokenpts</span><span class="p">:</span>
            <span class="n">newword</span> <span class="o">=</span> <span class="s2">&quot;z&#39;n&quot;</span>
            <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="p">[</span><span class="n">newword</span><span class="p">],</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pronunciation Variant&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;N-less informal possessive pronoun&#39;</span><span class="p">,</span>
                                            <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Pronunciation&#39;</span><span class="p">,</span> <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_word</span><span class="p">)</span>

    <span class="c1"># e-&gt; e(n)</span>
    <span class="n">enexceptions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;inne&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">known_word</span><span class="p">(</span>
            <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">)</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">basicreplacements</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enexceptions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">endsinschwa</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">monosyllabic</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">):</span>
            <span class="n">newword</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span> <span class="o">+</span> <span class="s1">&#39;n&#39;</span>
            <span class="k">if</span> <span class="n">known_word</span><span class="p">(</span><span class="n">newword</span><span class="p">):</span>
                <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="p">[</span><span class="n">newword</span><span class="p">],</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pronunciation Variant&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;N-drop after schwa&#39;</span><span class="p">,</span>
                                                <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Pronunciation&#39;</span><span class="p">,</span> <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_word</span><span class="p">)</span>

    <span class="c1"># initial s -&gt; z</span>
    <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">initdevoicing</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">newtokenmds</span><span class="p">,</span> <span class="n">beginmetadata</span><span class="p">)</span>
    <span class="c1"># initial f -&gt; v</span>
    <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">initdevoicing</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">newtokenmds</span><span class="p">,</span> <span class="n">beginmetadata</span><span class="p">)</span>

    <span class="c1"># replaceambiguous words with one reading not known by the child by a nonambiguous word with the same properties</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;tarsp&#39;</span><span class="p">,</span> <span class="s1">&#39;stap&#39;</span><span class="p">}:</span>
        <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">disambiguationdict</span><span class="p">:</span>
            <span class="n">newword</span> <span class="o">=</span> <span class="n">disambiguationdict</span><span class="p">[</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="n">newtokenmds</span> <span class="o">=</span> <span class="n">updatenewtokenmds</span><span class="p">(</span><span class="n">newtokenmds</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="p">[</span><span class="n">newword</span><span class="p">],</span> <span class="n">beginmetadata</span><span class="p">,</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Disambiguation&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Avoid unknown reading&#39;</span><span class="p">,</span>
                                            <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Lexicon&#39;</span><span class="p">,</span> <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_wordlemma</span><span class="p">)</span>

    <span class="c1"># ...en -&gt; e: groten  -&gt; grote (if adjective); goten -&gt; grote</span>

    <span class="c1"># drop e at the end incl duplicated consonants (ooke -&gt; ook; isse -&gt; is ? DOne, basicreplacements</span>

    <span class="c1"># losse e -&gt; een / het / de</span>

    <span class="k">for</span> <span class="n">newtokenmd</span> <span class="ow">in</span> <span class="n">newtokenmds</span><span class="p">:</span>
        <span class="n">morenewtokenmds</span> <span class="o">=</span> <span class="n">getalternativetokenmds</span><span class="p">(</span><span class="n">newtokenmd</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">tokenctr</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">uttid</span><span class="p">)</span>
        <span class="n">newtokenmds</span> <span class="o">+=</span> <span class="n">morenewtokenmds</span>

    <span class="k">return</span> <span class="n">newtokenmds</span>


<span class="k">def</span> <span class="nf">getvalidalternativetokenmds</span><span class="p">(</span><span class="n">tokenmd</span><span class="p">:</span> <span class="n">TokenMD</span><span class="p">,</span> <span class="n">newtokenmds</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenMD</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenMD</span><span class="p">]:</span>
    <span class="n">validnewtokenmds</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenmd</span> <span class="k">for</span> <span class="n">tokenmd</span> <span class="ow">in</span> <span class="n">newtokenmds</span> <span class="k">if</span> <span class="n">known_word</span><span class="p">(</span><span class="n">tokenmd</span><span class="o">.</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">validnewtokenmds</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">validnewtokenmds</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenmd</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">validnewtokenmds</span>


<div class="viewcode-block" id="gaatie"><a class="viewcode-back" href="../deviantlanguage.html#corrector.gaatie">[docs]</a><span class="k">def</span> <span class="nf">gaatie</span><span class="p">(</span><span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The function *gaatie* replaces  a word that matches with the gaatiepattern by a sequence of two words where</span>
<span class="sd">    the first word equals word[:-2] and the second word equals word[-2:]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">gaatiere</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">informlexicon</span><span class="p">(</span><span class="n">word</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]):</span>  <span class="c1"># and if it is a verb this is essential because now tie is also split into t ie</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">word</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">word</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]])</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>


<span class="k">def</span> <span class="nf">getwrongdetalternatives</span><span class="p">(</span><span class="n">tokensmd</span><span class="p">:</span> <span class="n">TokenListMD</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">SynTree</span><span class="p">,</span> <span class="n">uttid</span><span class="p">:</span> <span class="n">UttId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenListMD</span><span class="p">]:</span>
    <span class="n">correctiondone</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokensmd</span><span class="o">.</span><span class="n">tokens</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">tokensmd</span><span class="o">.</span><span class="n">metadata</span>
    <span class="n">ltokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="n">tokenctr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">newtokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">tokenctr</span> <span class="o">&lt;</span> <span class="n">ltokens</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">tokenctr</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">skip</span> <span class="ow">and</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">[</span><span class="n">de</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tokenctr</span> <span class="o">&lt;</span> <span class="n">ltokens</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nexttoken</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">tokenctr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="c1"># we want to exclude some words</span>
            <span class="k">if</span> <span class="n">nexttoken</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
                <span class="n">wordinfos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">WordInfo</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">nexttoken</span><span class="o">.</span><span class="n">word</span> <span class="ow">in</span> <span class="n">wrongdet_excluded_words</span><span class="p">:</span>
                <span class="n">wordinfos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wordinfos</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">getdehetwordinfo</span><span class="p">(</span><span class="n">nexttoken</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wordinfos</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">for</span> <span class="n">wordinfo</span> <span class="ow">in</span> <span class="n">wordinfos</span><span class="p">:</span>  <span class="c1"># if there are multiple alternatives we overwrite and therefore get the last alternative</span>
                    <span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dehet</span><span class="p">,</span> <span class="n">infl</span><span class="p">,</span> <span class="n">lemma</span><span class="p">)</span> <span class="o">=</span> <span class="n">wordinfo</span>
                    <span class="k">if</span> <span class="n">dehet</span> <span class="o">==</span> <span class="n">het</span> <span class="ow">and</span> <span class="n">infl</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;de&#39;</span><span class="p">]:</span>
                        <span class="c1"># newcurtoken = replacement(token, swapdehet(token))</span>
                        <span class="n">newcurtokenword</span> <span class="o">=</span> <span class="n">swapdehet</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">word</span><span class="p">)</span>
                        <span class="n">newcurtoken</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">newcurtokenword</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
                        <span class="n">meta</span> <span class="o">=</span> <span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">newcurtoken</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;GrammarError&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;deheterror&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;Error&#39;</span><span class="p">,</span>
                                           <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl_node</span><span class="p">)</span>
                        <span class="n">metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
                        <span class="n">correctiondone</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">newcurtokenword</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span>
                <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Token</span><span class="p">(</span><span class="n">newcurtokenword</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newcurtokenword</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">word</span>
                <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">tokenctr</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">TokenListMD</span><span class="p">(</span><span class="n">newtokens</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">correctiondone</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">getindezemwp</span><span class="p">(</span><span class="n">prevtokennode</span><span class="p">:</span> <span class="n">SynTree</span><span class="p">,</span> <span class="n">tokennode</span><span class="p">:</span> <span class="n">SynTree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">getattval</span><span class="p">(</span><span class="n">prevtokennode</span><span class="p">,</span> <span class="s1">&#39;lemma&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;in&#39;</span><span class="p">}</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">getattval</span><span class="p">(</span><span class="n">prevtokennode</span><span class="p">,</span> <span class="s1">&#39;rel&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;mwp&#39;</span><span class="p">}</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">getattval</span><span class="p">(</span><span class="n">tokennode</span><span class="p">,</span> <span class="s1">&#39;lemma&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;deze&#39;</span><span class="p">}</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">getattval</span><span class="p">(</span><span class="n">tokennode</span><span class="p">,</span> <span class="s1">&#39;rel&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;mwp&#39;</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">ok</span>


<span class="k">def</span> <span class="nf">correctPdit</span><span class="p">(</span><span class="n">tokensmd</span><span class="p">:</span> <span class="n">TokenListMD</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">SynTree</span><span class="p">,</span> <span class="n">uttid</span><span class="p">:</span> <span class="n">UttId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">TokenListMD</span><span class="p">]:</span>
    <span class="n">correctiondone</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">tokennodes</span> <span class="o">=</span> <span class="n">getnodeyield</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokensmd</span><span class="o">.</span><span class="n">tokens</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">tokensmd</span><span class="o">.</span><span class="n">metadata</span>
    <span class="n">newtokens</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tokenctr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">nonskiptokenctr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prevtoken</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
        <span class="n">tokennode</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">getattval</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;begin&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pos</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">subpos</span><span class="p">),</span> <span class="n">tokennodes</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">tokenlemma</span> <span class="o">=</span> <span class="n">getattval</span><span class="p">(</span><span class="n">tokennode</span><span class="p">,</span> <span class="s1">&#39;lemma&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">skip</span> <span class="ow">and</span> <span class="n">prevtoken</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">prevtoken</span><span class="o">.</span><span class="n">skip</span> <span class="ow">and</span> <span class="n">tokenlemma</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;dit&#39;</span><span class="p">,</span> <span class="s1">&#39;dat&#39;</span><span class="p">,</span> <span class="s1">&#39;deze&#39;</span><span class="p">,</span>
                                                                                              <span class="s1">&#39;die&#39;</span><span class="p">}:</span>
            <span class="n">tokenrel</span> <span class="o">=</span> <span class="n">getattval</span><span class="p">(</span><span class="n">tokennode</span><span class="p">,</span> <span class="s1">&#39;rel&#39;</span><span class="p">)</span>
            <span class="n">tokenpt</span> <span class="o">=</span> <span class="n">getattval</span><span class="p">(</span><span class="n">tokennode</span><span class="p">,</span> <span class="s1">&#39;pt&#39;</span><span class="p">)</span>
            <span class="n">prevtokennode</span> <span class="o">=</span> <span class="n">tokennodes</span><span class="p">[</span><span class="n">nonskiptokenctr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">tokenctr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">prevtokennode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prevpt</span> <span class="o">=</span> <span class="n">getattval</span><span class="p">(</span><span class="n">prevtokennode</span><span class="p">,</span> <span class="s1">&#39;pt&#39;</span><span class="p">)</span>
                <span class="n">prevparent</span> <span class="o">=</span> <span class="n">prevtokennode</span><span class="o">.</span><span class="n">getparent</span><span class="p">()</span>
                <span class="n">prevparentrel</span><span class="p">,</span> <span class="n">prevparentcat</span> <span class="o">=</span> <span class="n">getattval</span><span class="p">(</span><span class="n">prevparent</span><span class="p">,</span> <span class="s1">&#39;rel&#39;</span><span class="p">),</span> <span class="n">getattval</span><span class="p">(</span><span class="n">prevparent</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">)</span>
                <span class="n">indezemwp</span> <span class="o">=</span> <span class="n">getindezemwp</span><span class="p">(</span><span class="n">prevtokennode</span><span class="p">,</span> <span class="n">tokennode</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">prevpt</span> <span class="o">==</span> <span class="s1">&#39;vz&#39;</span> <span class="ow">and</span> <span class="n">prevparentcat</span> <span class="o">!=</span> <span class="s1">&#39;pp&#39;</span> <span class="ow">and</span> <span class="n">tokenrel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;det&#39;</span><span class="p">}</span> <span class="ow">and</span> <span class="n">tokenpt</span> <span class="o">==</span> <span class="s1">&#39;vnw&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="n">indezemwp</span><span class="p">:</span>
                    <span class="n">newtoken</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="s1">&#39;hem&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">subpos</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">subpos</span><span class="p">)</span>
                    <span class="n">bpl</span> <span class="o">=</span> <span class="n">bpl_indeze</span> <span class="k">if</span> <span class="n">indezemwp</span> <span class="k">else</span> <span class="n">bpl_node</span>
                    <span class="n">meta</span> <span class="o">=</span> <span class="n">mkSASTAMeta</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">newtoken</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;parsed as&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;hem&#39;</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s1">&#39;AlpinoImprovement&#39;</span><span class="p">,</span>
                                       <span class="n">backplacement</span><span class="o">=</span><span class="n">bpl</span><span class="p">)</span>
                    <span class="n">metadata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
                    <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newtoken</span><span class="p">)</span>
                    <span class="n">correctiondone</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newtokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">tokenctr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
            <span class="n">nonskiptokenctr</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">prevtoken</span> <span class="o">=</span> <span class="n">token</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">TokenListMD</span><span class="p">(</span><span class="n">newtokens</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">correctiondone</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">results</span>


<span class="k">def</span> <span class="nf">parseas</span><span class="p">(</span><span class="n">w</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;[ @add_lex </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> ]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">swapdehet</span><span class="p">(</span><span class="n">dedet</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">dedet</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">[</span><span class="n">de</span><span class="p">]:</span>
        <span class="n">deindex</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[</span><span class="n">de</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dedet</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">dedet</span> <span class="ow">in</span> <span class="n">dets</span><span class="p">[</span><span class="n">het</span><span class="p">]:</span>
        <span class="n">hetindex</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[</span><span class="n">het</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dedet</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hetindex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">deindex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[</span><span class="n">het</span><span class="p">][</span><span class="n">deindex</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">hetindex</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">dets</span><span class="p">[</span><span class="n">de</span><span class="p">][</span><span class="n">hetindex</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">outputalternatives</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">alternatives</span><span class="p">,</span> <span class="n">outfile</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">alternatives</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">el</span><span class="p">],</span> <span class="n">slash</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">alternatives</span><span class="p">[</span><span class="n">el</span><span class="p">]),</span> <span class="n">file</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">mkchatutt</span><span class="p">(</span><span class="n">intokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">outtokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">intoken</span><span class="p">,</span> <span class="n">outtoken</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">intokens</span><span class="p">,</span> <span class="n">outtokens</span><span class="p">):</span>
        <span class="n">newtoken</span> <span class="o">=</span> <span class="n">intoken</span> <span class="k">if</span> <span class="n">intoken</span> <span class="o">==</span> <span class="n">outtoken</span> <span class="k">else</span> <span class="n">replacement</span><span class="p">(</span><span class="n">intoken</span><span class="p">,</span> <span class="n">outtoken</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newtoken</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">altmkchatutt</span><span class="p">(</span><span class="n">intokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">outtoken</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">intoken</span> <span class="ow">in</span> <span class="n">intokens</span><span class="p">:</span>
        <span class="n">newtoken</span> <span class="o">=</span> <span class="n">intoken</span> <span class="k">if</span> <span class="n">intoken</span> <span class="o">==</span> <span class="n">outtoken</span> <span class="k">else</span> <span class="n">replacement</span><span class="p">(</span><span class="n">intoken</span><span class="p">,</span> <span class="n">outtoken</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newtoken</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">SASTA  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">corrector</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Jan Odijk, Jelte van Boheemen, Martin Kroon.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>